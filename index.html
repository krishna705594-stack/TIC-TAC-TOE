<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tic Tac Toe Online</title>
  <style>
    body {
      font-family: 'Press Start 2P', cursive;
      text-align: center;
      background: #f3f3f3;
      overflow-x: hidden;
    }

    h1 {
      margin-top: 40px;
    }

    .board {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-template-rows: repeat(3, 100px);
      gap: 10px;
      justify-content: center;
      margin-top: 30px;
    }

    .cell {
      background: white;
      border: 2px solid black;
      font-size: 36px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }

    button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }

    #status {
      margin-top: 15px;
      font-size: 14px;
      color: gray;
    }

    /* üîπ Win Screen Overlay */
    #winScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 28px;
      z-index: 999;
    }

    #chatBox {
      position: fixed;
      right: 20px;
      bottom: 20px;
      width: 260px;
      background: white;
      border: 2px solid #333;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      height: 300px;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      text-align: left;
      font-size: 12px;
    }

    #chatInput {
      display: flex;
      border-top: 1px solid #ccc;
    }

    #chatInput input {
      flex: 1;
      border: none;
      padding: 8px;
      outline: none;
    }

    #chatInput button {
      background: #222;
      color: white;
      border: none;
      padding: 8px 10px;
      cursor: pointer;
    }

    #emojiPicker {
      display: none;
      position: absolute;
      bottom: 60px;
      right: 30px;
      background: white;
      border: 1px solid #ccc;
      padding: 5px;
      border-radius: 5px;
    }

    #emojiPicker span {
      cursor: pointer;
      font-size: 20px;
      padding: 4px;
    }
  </style>
</head>
<body>
  <h1>TIC-TAC-TOE</h1>
  <p>JUST FOR PLAYING WITH MY FRIENDS...</p>

  <!-- üîπ Room Controls -->
  <div style="text-align:center; margin-bottom:20px;">
    <input type="text" id="playerName" placeholder="Enter Your Name">
    <input type="text" id="roomCode" placeholder="Enter Room Code">
    <button id="createRoom">Create Room</button>
    <button id="joinRoom">Join Room</button>
    <p id="status">Waiting for action...</p>
  </div>

  <!-- üîπ Game Board -->
  <div class="board" id="board"></div>
  <button id="resetButton">Reset Game</button>

  <!-- üîπ Win Screen -->
  <div id="winScreen">
    <h2 id="winnerText"></h2>
    <button onclick="hideWinScreen()">Play Again</button>
  </div>

  <!-- üîπ Chat Box -->
  <div id="chatBox">
    <div id="messages"></div>
    <div id="chatInput">
      <button id="emojiBtn">üòä</button>
      <input type="text" id="messageText" placeholder="Type a message...">
      <button id="sendBtn">Send</button>
    </div>
    <div id="emojiPicker">
      <span>üòÄ</span><span>üòÇ</span><span>üòé</span><span>‚ù§Ô∏è</span><span>üî•</span><span>üëç</span>
    </div>
  </div>

  <!-- üîπ Firebase + Game Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, update, push } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB2wrRxkm8NlDcoa9_6q6a3PjyWXMrsIOk",
      authDomain: "tic-tac-toe-online-24631.firebaseapp.com",
      projectId: "tic-tac-toe-online-24631",
      storageBucket: "tic-tac-toe-online-24631.firebasestorage.app",
      messagingSenderId: "812537114665",
      appId: "1:812537114665:web:b8eec1edebc355cfa9ec38",
      databaseURL: "https://tic-tac-toe-online-24631-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const boardElement = document.getElementById("board");
    const status = document.getElementById("status");
    const roomInput = document.getElementById("roomCode");
    const createRoomBtn = document.getElementById("createRoom");
    const joinRoomBtn = document.getElementById("joinRoom");
    const resetBtn = document.getElementById("resetButton");
    const playerNameInput = document.getElementById("playerName");

    const winScreen = document.getElementById("winScreen");
    const winnerText = document.getElementById("winnerText");

    const chatMessages = document.getElementById("messages");
    const messageText = document.getElementById("messageText");
    const sendBtn = document.getElementById("sendBtn");
    const emojiPicker = document.getElementById("emojiPicker");
    const emojiBtn = document.getElementById("emojiBtn");

    let roomCode = "";
    let currentPlayer = "X";
    let mySymbol = "";
    let playerName = "";
    let board = ["", "", "", "", "", "", "", "", ""];

    // Create cells
    for (let i = 0; i < 9; i++) {
      const cell = document.createElement("div");
      cell.classList.add("cell");
      cell.addEventListener("click", () => makeMove(i));
      boardElement.appendChild(cell);
    }

    // Create room
    createRoomBtn.onclick = async () => {
      playerName = playerNameInput.value.trim() || "Player 1";
      roomCode = Math.random().toString(36).substring(2, 7).toUpperCase();
      mySymbol = "X";
      await set(ref(db, "rooms/" + roomCode), {
        board: board,
        currentPlayer: "X",
        players: { X: playerName }
      });
      status.textContent = `Room Created: ${roomCode}. Waiting for player O...`;
      listenRoom();
      listenChat();
    };

    // Join room
    joinRoomBtn.onclick = async () => {
      playerName = playerNameInput.value.trim() || "Player 2";
      roomCode = roomInput.value.trim().toUpperCase();
      if (!roomCode) return alert("Enter a room code!");
      const snapshot = await get(ref(db, "rooms/" + roomCode));
      if (!snapshot.exists()) return alert("Room not found!");
      mySymbol = "O";
      await update(ref(db, "rooms/" + roomCode + "/players"), { O: playerName });
      status.textContent = `Joined room ${roomCode}. You are O.`;
      listenRoom();
      listenChat();
    };

    // Listen room changes
    function listenRoom() {
      onValue(ref(db, "rooms/" + roomCode), (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        board = data.board;
        currentPlayer = data.currentPlayer;
        updateBoardUI();
        checkWinner();
      });
    }

    // Make a move
    async function makeMove(i) {
      if (board[i] || currentPlayer !== mySymbol) return;
      board[i] = mySymbol;
      currentPlayer = mySymbol === "X" ? "O" : "X";
      await update(ref(db, "rooms/" + roomCode), {
        board: board,
        currentPlayer: currentPlayer,
      });
      checkWinner();
    }

    // Update UI
    function updateBoardUI() {
      const cells = document.querySelectorAll(".cell");
      board.forEach((val, i) => (cells[i].textContent = val));
      status.textContent = `Room: ${roomCode} | Turn: ${currentPlayer}`;
    }

    // Check winner
    function checkWinner() {
      const wins = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
      for (const combo of wins) {
        const [a,b,c] = combo;
        if (board[a] && board[a] === board[b] && board[a] === board[c]) {
          showWinScreen(board[a]);
          return;
        }
      }
    }

    function showWinScreen(symbol) {
      get(ref(db, "rooms/" + roomCode + "/players")).then(snapshot => {
        const players = snapshot.val();
        const winnerName = players[symbol] || "Player";
        winnerText.textContent = `${winnerName} Wins!`;
        winScreen.style.display = "flex";
      });
    }

    window.hideWinScreen = () => {
      winScreen.style.display = "none";
      resetBtn.click();
    };

    // Reset game
    resetBtn.onclick = async () => {
      if (!roomCode) return;
      board = ["", "", "", "", "", "", "", "", ""];
      await update(ref(db, "rooms/" + roomCode), {
        board: board,
        currentPlayer: "X",
      });
      winScreen.style.display = "none";
    };

    // Chat System
    sendBtn.onclick = async () => {
      if (!roomCode) return;
      const text = messageText.value.trim();
      if (!text) return;
      await push(ref(db, "chats/" + roomCode), {
        name: playerName,
        msg: text
      });
      messageText.value = "";
    };

    function listenChat() {
      onValue(ref(db, "chats/" + roomCode), (snapshot) => {
        chatMessages.innerHTML = "";
        snapshot.forEach((child) => {
          const data = child.val();
          const div = document.createElement("div");
          div.textContent = `${data.name}: ${data.msg}`;
          chatMessages.appendChild(div);
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
    }

    // Emoji Picker
    emojiBtn.onclick = () => {
      emojiPicker.style.display = emojiPicker.style.display === "block" ? "none" : "block";
    };

    emojiPicker.querySelectorAll("span").forEach(e => {
      e.onclick = () => {
        messageText.value += e.textContent;
        emojiPicker.style.display = "none";
      };
    });
  </script>
</body>
</html>
