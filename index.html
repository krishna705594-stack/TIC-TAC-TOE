<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tic Tac Toe Online</title>
  <style>
    body {
      font-family: 'Press Start 2P', cursive;
      text-align: center;
      background: #f3f3f3;
      margin: 0;
      overflow-x: hidden;
    }

    h1 {
      margin-top: 30px;
      font-size: 22px;
    }

    .board {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-template-rows: repeat(3, 100px);
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    .cell {
      background: white;
      border: 2px solid black;
      font-size: 36px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }

    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
    }

    #status {
      margin-top: 10px;
      font-size: 14px;
      color: gray;
    }

    /* ðŸ”¹ Rules Styles */
    #rules {
      margin: 20px auto;
      max-width: 600px;
      text-align: left;
      background: white;
      border: 2px solid black;
      padding: 15px;
      font-family: Arial, sans-serif;
      font-size: 14px;
    }

    /* ðŸ”¹ Chat Styles */
    #chatBubble {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      border: 2px solid black;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    #notificationDot {
      position: absolute;
      top: 10px;
      right: 10px;
      background: red;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: none;
    }

    #chatBox {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 300px;
      max-height: 400px;
      background: white;
      border: 2px solid black;
      border-radius: 10px;
      display: none;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      z-index: 999;
    }

    #chatHeader {
      background: black;
      color: white;
      padding: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }

    #closeChat {
      background: none;
      color: white;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }

    #chatMessages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      text-align: left;
      font-family: Arial, sans-serif;
      font-size: 14px;
    }

    #chatInputArea {
      display: flex;
      border-top: 1px solid #ccc;
    }

    #chatInput {
      flex: 1;
      border: none;
      padding: 10px;
      font-size: 14px;
      outline: none;
    }

    #sendBtn {
      border: none;
      background: black;
      color: white;
      padding: 0 15px;
      font-size: 16px;
      cursor: pointer;
    }

    @media (max-width: 600px) {
      .board {
        grid-template-columns: repeat(3, 80px);
        grid-template-rows: repeat(3, 80px);
      }
      #chatBox {
        width: 90%;
        right: 5%;
      }
    }
  </style>
</head>
<body>
  <h1>TIC-TAC-TOE</h1>
  <p>JUST FOR PLAYING WITH MY FRIENDS...</p>

  <!-- ðŸ”¹ Rules Section -->
  <div id="rules">
    <h3>Game Rules:</h3>
    <ul>
      <li>The game is played on a 3x3 grid.</li>
      <li>Players take turns placing their mark (X or O) in an empty cell.</li>
      <li>The first player to get three of their marks in a row (horizontally, vertically, or diagonally) wins.</li>
      <li>If all 9 cells are filled without a winner, it's a draw.</li>
      <li>Be fair: Wait for your turn and don't cheat!</li>
    </ul>
  </div>

  <!-- ðŸ”¹ Room Controls -->
  <div style="text-align:center; margin-bottom:20px;">
    <input type="text" id="playerName" placeholder="Enter Your Name">
    <input type="text" id="roomCode" placeholder="Enter Room Code">
    <button id="createRoom">Create Room</button>
    <button id="joinRoom">Join Room</button>
    <p id="status">Waiting for action...</p>
  </div>

  <!-- ðŸ”¹ Game Board -->
  <div class="board" id="board"></div>
  <button id="resetButton">Reset Game</button>

  <!-- ðŸ”¹ Chat System -->
  <div id="chatBubble">ðŸ’¬
    <div id="notificationDot"></div>
  </div>

  <div id="chatBox">
    <div id="chatHeader">
      Chat Room
      <button id="closeChat">âœ–</button>
    </div>
    <div id="chatMessages"></div>
    <div id="chatInputArea">
      <input id="chatInput" type="text" placeholder="Type a message..." />
      <button id="sendBtn">âž¤</button>
    </div>
  </div>

  <!-- ðŸ”¹ Firebase + Game + Chat Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, update, push } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB2wrRxkm8NlDcoa9_6q6a3PjyWXMrsIOk",
      authDomain: "tic-tac-toe-online-24631.firebaseapp.com",
      projectId: "tic-tac-toe-online-24631",
      storageBucket: "tic-tac-toe-online-24631.firebasestorage.app",
      messagingSenderId: "812537114665",
      appId: "1:812537114665:web:b8eec1edebc355cfa9ec38",
      databaseURL: "https://tic-tac-toe-online-24631-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const boardElement = document.getElementById("board");
    const status = document.getElementById("status");
    const roomInput = document.getElementById("roomCode");
    const playerNameInput = document.getElementById("playerName");
    const createRoomBtn = document.getElementById("createRoom");
    const joinRoomBtn = document.getElementById("joinRoom");
    const resetBtn = document.getElementById("resetButton");

    // Chat elements
    const chatBubble = document.getElementById("chatBubble");
    const chatBox = document.getElementById("chatBox");
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");
    const closeChat = document.getElementById("closeChat");
    const notificationDot = document.getElementById("notificationDot");

    let roomCode = "";
    let currentPlayer = "X";
    let mySymbol = "";
    let board = ["", "", "", "", "", "", "", "", ""];
    let gameOver = false;
    let chatOpen = false;

    // Create game cells
    for (let i = 0; i < 9; i++) {
      const cell = document.createElement("div");
      cell.classList.add("cell");
      cell.addEventListener("click", () => makeMove(i));
      boardElement.appendChild(cell);
    }

    createRoomBtn.onclick = async () => {
      roomCode = Math.random().toString(36).substring(2, 7).toUpperCase();
      mySymbol = "X";
      gameOver = false;
      await set(ref(db, "rooms/" + roomCode), {
        board: board,
        currentPlayer: "X",
        gameOver: false,
        winner: ""
      });
      status.textContent = `Room Created: ${roomCode}. Waiting for player O...`;
      listenRoom();
      listenChat();
    };

    joinRoomBtn.onclick = async () => {
      roomCode = roomInput.value.trim().toUpperCase();
      if (!roomCode) return alert("Enter a room code!");
      const snapshot = await get(ref(db, "rooms/" + roomCode));
      if (!snapshot.exists()) return alert("Room not found!");
      mySymbol = "O";
      gameOver = false;
      await update(ref(db, "rooms/" + roomCode), {});
      status.textContent = `Joined room ${roomCode}. You are O.`;
      listenRoom();
      listenChat();
    };

    function listenRoom() {
      onValue(ref(db, "rooms/" + roomCode), (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        board = data.board;
        currentPlayer = data.currentPlayer;
        gameOver = data.gameOver || false;
        const winner = data.winner || "";
        updateBoardUI();
        if (gameOver) {
          status.textContent = winner ? `Player ${winner} wins!` : "It's a draw!";
        } else {
          status.textContent = `Room: ${roomCode} | Turn: ${currentPlayer}`;
        }
      });
    }

    async function makeMove(i) {
      if (board[i] || currentPlayer !== mySymbol || gameOver) return;
      board[i] = mySymbol;
      const winner = checkWinner();
      if (winner) {
        gameOver = true;
        await set(ref(db, "rooms/" + roomCode), {
          board: board,
          currentPlayer: currentPlayer,
          gameOver: true,
          winner: winner
        });
      } else if (board.every(cell => cell !== "")) {
        gameOver = true;
        await set(ref(db, "rooms/" + roomCode), {
          board: board,
          currentPlayer: currentPlayer,
          gameOver: true,
          winner: ""
        });
      } else {
        currentPlayer = mySymbol === "X" ? "O" : "X";
        await set(ref(db, "rooms/" + roomCode), {
          board: board,
          currentPlayer: currentPlayer,
          gameOver: false,
          winner: ""
        });
      }
    }

    function checkWinner() {
      const winPatterns = [
        [0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
        [0, 3, 6], [1, 4, 7], [2, 5, 8], // columns
        [0, 4, 8], [2, 4, 6] // diagonals
      ];
      for (let pattern of winPatterns) {
        const [a, b, c] = pattern;
        if (board[a] && board[a] === board[b] && board[a] === board[c]) {
          return board[a];
        }
      }
      return null;
    }

    function updateBoardUI() {
      const cells = document.querySelectorAll(".cell");
      board.forEach((val, i) => {
        cells[i].textContent = val;
      });
    }

    resetBtn.onclick = async () => {
      if (!roomCode) return;
      board = ["", "", "", "", "", "", "", "", ""];
      gameOver = false;
      await set(ref(db, "rooms/" + roomCode), {
        board: board,
        currentPlayer: "X",
        gameOver: false,
        winner: ""
      });
    };

    // ðŸ”¹ Chat Functions
    chatBubble.onclick = () => {
      chatBox.style.display = "flex";
      chatBubble.style.display = "none";
      chatOpen = true;
      notificationDot.style.display = "none";
    };

    closeChat.onclick = () => {
      chatBox.style.display = "none";
      chatBubble.style.display = "flex";
      chatOpen = false;
    };

    sendBtn.onclick = sendMessage;
    chatInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    async function sendMessage() {
      const msg = chatInput.value.trim();
      const name = playerNameInput.value || "Player";
      if (!msg || !roomCode) return;
      const msgRef = ref(db, "rooms/" + roomCode + "/chat");
      await push(msgRef, { name, msg, time: Date.now() });
      chatInput.value = "";
    }

    function listenChat() {
      onValue(ref(db, "rooms/" + roomCode + "/chat"), (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        chatMessages.innerHTML = "";
        Object.values(data).forEach((m) => {
          const div = document.createElement("div");
          div.textContent = `${m.name}: ${m.msg}`;
          chatMessages.appendChild(div);
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
        if (!chatOpen) notificationDot.style.display = "block";
      });
    }
  </script>
</body>
</html>
